# Ants

ants æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½ä¸”ä½æŸè€—çš„ goroutine æ± ã€‚

https://github.com/panjf2000/ants

ä¸»è¦æ€æƒ³ï¼šä»¥ç©ºé—´æ¢æ—¶é—´ã€‚å†™ go å¹¶å‘ç¨‹åºçš„æ—¶å€™å¦‚æœç¨‹åºä¼šå¯åŠ¨å¤§é‡çš„ goroutine ï¼ŒåŠ¿å¿…ä¼šæ¶ˆè€—å¤§é‡çš„ç³»ç»Ÿèµ„æºï¼ˆå†…å­˜ï¼ŒCPUï¼‰ï¼Œé€šè¿‡ä½¿ç”¨ `ants`ï¼Œå¯ä»¥å®ä¾‹åŒ–ä¸€ä¸ª goroutine æ± ï¼Œå¤ç”¨ goroutine ï¼ŒèŠ‚çœèµ„æºï¼Œæå‡æ€§èƒ½ã€‚

Antsä¾èµ–äºGoåº•å±‚çš„ä¸€äº›å®ç°ï¼Œæ¯”å¦‚Lockerã€sync.Pool

## Locker

`Lockeræ˜¯ä¸€ä¸ªæ¥å£ï¼Œä»»ä½•å®ç°äº†Lockeræ–¹æ³•çš„ç»“æ„ä½“(ç±»)éƒ½å¯ä»¥ç§°ä½œä¸ºé”ğŸ”’`

```go
type Locker interface{
    Lock()
    Unlock()
}
```

æœ€å…¸å‹çš„sync.Mutexäº’æ–¥é”å°±å®ç°äº†Lockeræ¥å£ï¼Œè¿™æ˜¯ä¸€ç§ç›¸å¯¹é‡é‡çº§çš„é”ã€‚å› æ­¤ï¼ŒAntsçš„ä½œè€…è‡ªå·±å®ç°äº†ä¸€ç§è½»é‡çº§çš„è‡ªæ—‹é”(Spin Lockåœ¨çŸ­æœŸå†…,å¹¶å‘ç¨‹åº¦ä¸æ˜¯å¾ˆæ¿€çƒˆçš„æƒ…å†µä¸‹,è‡ªæ—‹é”ä¼šæœ‰ä¸€å®šçš„ä¼˜åŠ¿)

è¯¥è‡ªæ—‹é”çš„å®ç°åŸç†ï¼š

1. ä½¿ç”¨æ— ç¬¦å·æ•´å‹æ¥æ ‡è¯†é”çš„çŠ¶æ€ï¼Œ0-æœªä¸Šé”ï¼Œ1-å·²ä¸Šé”
2. åŠ é”æ—¶0->1,è§£é”1->0  CAS
3. é€šè¿‡è®¾ç½®ä¸€ä¸ªbackoffå€¼æ¥ååº”æŠ¢é”æ¿€çƒˆç¨‹åº¦,æ¯æ¬¡æŠ¢é”å¤±è´¥éƒ½ç­‰å¾…backoffæ¬¡CPUæ—¶é—´ç‰‡;backoffå€¼éšç€å¤±è´¥çš„æ¬¡æ•°è€Œå¢åŠ ï¼Œæœ€é«˜è¾¾åˆ°16

## Sync.Pool  å¯¹è±¡æ± 

`sync.Poolæ˜¯Golangæ ‡å‡†åº“ä¸‹å¹¶å‘å®‰å…¨çš„å¯¹è±¡æ± ,é€‚åˆç”¨äºæœ‰å¤§é‡å¯¹è±¡èµ„æºä¼šå­˜åœ¨åå¤æ„é€ å’Œé”€æ¯çš„åœºæ™¯,å¯ç¼“å­˜èµ„æºè¿›è¡Œå¤ç”¨,ä»¥æé«˜æ€§èƒ½å¹¶å‡è½»GCå‹åŠ› `   syns.Poolé‡Œçš„ä¸€äº›æ“ä½œå’Œå…¶ä¸­çš„å›æ”¶æœºåˆ¶æ€»ä½“ä¸Šæ¥çœ‹éƒ½è·ŸBufferPoolå¾ˆåƒï¼Œä½†å…·ä½“ç»†èŠ‚åˆæœ‰æ‰€ä¸åŒã€‚

sync.Poolä¸­æœ‰ä¸€ä¸ªlocal [P]poolLocal æ•°ç»„ï¼Œå…¶ä¸­len(p) = GOMAXPROCS,ä¹Ÿå³ä¸ºæ¯ä¸€ä¸ªpè°ƒåº¦å™¨éƒ½ç»´æŠ¤äº†ä¸€ä¸ªpoolLocalç±»å‹çš„å…ƒç´ ï¼ŒpoolLocalä¸­åˆ†ä¸ºprivateå¯¹è±¡å’ŒsharedListå¯¹è±¡(åŠ é”)

#### æ ¸å¿ƒæ–¹æ³•ï¼š

#### Pool.Pin()

Pool.Pin()   å°†Goroutineå’ŒPç»‘å®šèµ·æ¥,åœ¨æ‰§è¡Œunpin()æ–¹æ³•ä¹‹å‰ä¸èƒ½è§£ç»‘ã€‚ç›®çš„ï¼šå½“å‰Goroutineå¯èƒ½åç»­ä¼šä»Poolä¸­æ— é”åŒ–çš„å–åˆ°private,å¦‚æœæ­¤æ—¶å‘ç”Ÿäº†Goroutineçš„è°ƒåº¦åˆ‡æ¢,å¯èƒ½ä¼šäº§ç”Ÿæ„æ–™ä¹‹å¤–çš„é”™è¯¯,å› æ­¤éœ€è¦ç»‘å®šã€‚

#### Pool.Get()

å·²æœ‰çš„è¯æƒ³ç”¨ç›´æ¥æ‹¿ï¼Œä¸è¦åˆ›é€ 

1. å…ˆæ‹¿ç§æœ‰
2. ç§æœ‰æ²¡äº†ï¼Œå»é‚£SharedListé‡Œçš„headï¼Œå¯èƒ½æ¶‰åŠåˆ°åŠ é”
3. å†æ²¡æœ‰ï¼Œå»ä¸Šä¸€è½®çš„poolLocalä¸­æ‹¿
4. éƒ½æ²¡æœ‰ï¼Œè°ƒç”¨New()æ–¹æ³•åˆ›é€   ï¼ˆè°ƒç”¨ç”¨æˆ·æå‰å£°æ˜çš„æ„é€ å™¨å‡½æ•°ï¼‰

#### Pool.Put()

ç”¨å®Œäº†ï¼Œæ”¾å›å¯¹è±¡æ± 

æ”¾å›çš„æ—¶å€™ä¹Ÿè¦å…ˆè°ƒç”¨Pin()æ–¹æ³•ï¼Œå› ä¸ºå…ˆæ”¾å›çš„æ—¶å€™ä¹Ÿè¦å…ˆå°è¯•æ”¾å›private,åªè¦å’Œå½“å‰çš„privateæœ‰äº¤äº’ï¼Œå°±éœ€è¦å’Œpç»‘å®š,è¿™æ ·æ‰èƒ½ä¿è¯å’Œprivateäº¤äº’çš„æ— é”åŒ–ã€‚å¦‚æœå½“å‰privateä¸ºç©ºï¼Œåˆ™æ”¾å…¥ï¼Œå¦åˆ™æ”¾å…¥sharedListçš„å¤´éƒ¨ã€‚æ”¾å®Œåæ‰§è¡ŒUnpin()æ“ä½œã€‚

### å›æ”¶æœºåˆ¶

`å­˜å…¥poolçš„å¯¹åƒä¼šè¢«ä¸å®šæœŸçš„å›æ”¶,å› æ­¤poolæ²¡æœ‰å®¹é‡çš„æ¦‚å¿µ,å³ä¾¿å­˜å…¥å¤§é‡å…ƒç´ ï¼Œä¹Ÿä¸ä¼šå‘ç”Ÿå†…å­˜æ³„éœ²ï¼Œå¯¹è±¡çš„å›æ”¶æ—¶æœºä¸å›ºå®šï¼Œå–å†³äºGCçš„æ—¶æœº`

ç»è¿‡ä¸€è½®GCåLocalçš„æ•°æ®ä¼šè¢«è½¬ç§»è‡³victimï¼ˆvictim [p]poolLocal   victimå­˜çš„æ˜¯ä¸Šä¸€è½®çš„æ•°æ®ï¼‰,å†ç»è¿‡ä¸€è½®GCï¼Œvictimä¸­çš„æ•°æ®å°±ä¼šçœŸæ­£çš„è¢«GCæ‰ã€‚

## Ants åç¨‹æ± 

ä½¿ç”¨åç¨‹æ± çš„ç†ç”±

1. åœ¨ç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä¸éœ€è¦ç”¨åˆ°åç¨‹æ± ï¼Œå› ä¸ºgoroutineæœ¬èº«å·²ç»å¾ˆå¼ºå¤§,ä½†æ˜¯ä¼šæœ‰æç«¯çš„åœºæ™¯å‡ºç°ã€‚ä½†æ˜¯å½“goroutineçš„é‡çº§è¾¾åˆ°ä¸€å®šç¨‹åº¦çš„æ—¶å€™ï¼Œå¤§æ‰¹é‡çš„åç¨‹åˆ›å»º/é”€æ¯æˆæœ¬è¿‡é«˜ã€‚
2. å¯¹å¹¶å‘èµ„æºçš„æ§åˆ¶ï¼Œé€šè¿‡åç¨‹æ± åˆ›å»ºåç¨‹ï¼Œä»è€Œå¯¹å…¨å±€çš„å¹¶å‘åº¦è¿›è¡Œæ§åˆ¶,é™å®šæ± ä¸­åç¨‹çš„æ•°é‡ã€‚
3. å¯ä»¥å®æ—¶æŸ¥çœ‹å½“å‰å…¨å±€å¹¶å‘åç¨‹çš„æ•°é‡
4. æœ‰ä¸€ä¸ªç´§æ€¥å…¥å£å¯ä»¥ä¸€æ¬¡æ€§çš„é‡Šæ”¾å…¨å±€åç¨‹

## Antsæ•°æ®ç»“æ„

```go
type Pool struct {
	capacity     int32       //æ± å­çš„å®¹é‡
	running      int32       //è¿è¡Œä¸­çš„åç¨‹æ•°é‡  å·²ç»æœ‰å¤šå°‘ä¸ªgoroutineè¢«å–å‡º
	lock         sync.Locker //è‡ªå®ç°çš„è‡ªæ—‹é”
	workers      workerArray //åç¨‹åˆ—è¡¨  goroutineè¢«å°è£…æˆäº†go worker 
	state        int32       //æ± å­çš„çŠ¶æ€
    cond         *sync.Cond  //å¹¶å‘åè°ƒå™¨   é€šè¿‡è°ƒç”¨wait()å’Œsignal() æ¥åè°ƒåç¨‹  å·²ç”¨å®Œ
	workerCache  sync.Pool   //åç¨‹å›æ”¶ç«™
	waiting      int32       //é˜»å¡ç­‰å¾…çš„åç¨‹æ•°é‡
	purgeDone    int32
	stopPurge    context.CancelFunc
	ticktockDone int32
	stopTicktock context.CancelFunc
	now          atomic.Value
	options      *Options //ä¸€äº›å®šåˆ¶åŒ–é…ç½®
}

workerArrayå’ŒworkerCacheçš„åŒºåˆ«ï¼šworkerArrayæ˜¯å½“å‰è¿˜çœŸå®å­˜åœ¨ä¸”å¯ç”¨çš„go worker,workerCacheæ˜¯åç¨‹å›æ”¶ç«™ï¼ŒworkerCacheä¸­çš„åç¨‹æ˜¯å·²ç»è¢«é€»è¾‘åˆ é™¤ï¼Œä½†è¿˜æ²¡æœ‰è¢«ç‰©ç†åˆ é™¤ï¼Œéœ€è¦è¢«GCæ‰ã€‚ä½•æ—¶è¢«åˆ é™¤ï¼Œè¿™å–å†³äºGCçš„æ—¶æœº
```

### go worker

```go
type goWorker struct {
    pool *Pool   //å¹¶ä¸æ„å‘³ç€goWorkeråŒ…å«äº†poolï¼Œè€Œæ˜¯goWorkeréœ€è¦*Poolæ¥æ‰¾åˆ°å…¶å±äºå“ªä¸ªPool,æ‰¾åˆ°å…¶å›æ± çš„è·¯å¾„
    task chan func() //éå¸¸ç²¾å½©çš„è®¾è®¡ï¼Œæ‰€è°“çš„åç¨‹æ± ,å®ƒèƒ½å¤Ÿåˆ›å»ºåç¨‹ï¼Œä½†æ˜¯åˆ›å»ºçš„åç¨‹ä¸èƒ½è¿”å›ï¼Œéœ€è¦å…¶é•¿æ—¶é—´è¿ä½œ,å¦‚æœgo func()çœŸå®è¿”å›äº†ï¼Œé‚£ä¹ˆåœ¨åç»­çš„ä½¿ç”¨go Workerè¿˜éœ€è¦è°ƒç”¨go func(),è¿™å…¶å®æ˜¯æ²¡æœ‰è¾¾åˆ°å¤ç”¨åç¨‹çš„ç›®çš„ã€‚é€šè¿‡ä¸åœçš„è½®è¯¢è¯¥chanæ¥ä¾¦æµ‹å¤–ç•Œæ˜¯å¦æœ‰ä»»åŠ¡ä¼ é€’è¿›æ¥ï¼Œå¦‚æœæ²¡æœ‰å°±é˜»å¡ä½ï¼Œå¹¶ä¸ä¼šè¿”å›ã€‚
    recycleTime time.Time //å›æ”¶åˆ°cecheæ—¶é—´    workArray -> workerCache
}
```

### options

åœ¨åˆ›å»ºpoolæ—¶é€šè¿‡æ„é€ å™¨ä¼ é€’å‚æ•°ï¼Œä»è€Œå®šåˆ¶åŒ–pool

```go
type Options struct{
    DisablePurge bool //æ˜¯å¦å…è®¸å›æ”¶ç©ºé—²çš„goWorker
    ExpiryDuration time.Duration //ç©ºé—²å¤šé•¿æ—¶é—´è¿›è¡Œå›æ”¶,ä»…å½“ä¸Šä¸ªå‚æ•°ä¸ºFalseæ—¶ç”Ÿæ•ˆ
    MaxBlockingTasks int //æ˜¯å¦è®¾ç½®ä¸ºé˜»å¡æ¨¡å¼ï¼Œå¦‚æœæ˜¯,goWorkerä¸å¤Ÿæ—¶ä¸ç­‰å¾…ï¼Œç›´æ¥è¿”å›err
    Nonblocking bool  //é˜»å¡è¿˜æ˜¯éé˜»å¡æ ‡è¯†  é€šè¿‡cond  wait() signal()
    PanicHandler func(interface{}) //å®šåˆ¶panicå¤„ç†é€»è¾‘  antså®ç°äº†ä¸€ä¸ªé»˜è®¤çš„panicå…œåº•(æ–¹æ³•æ ˆæ‰“å°)
}
```

### workerArray

```go
type workerArray interface {
	len() int
	isEmpty() bool
	insert(worker *goWorker) error
	detach() *goWorker
	retrieveExpiry(duration time.Duration) []*goWorker //ä½¿ç”¨åˆ°äº†äºŒåˆ†æŸ¥æ‰¾ n -> logn åŠ é€Ÿ
	reset()
}
```





